(("undefined"!==typeof self?self:this)["webpackChunkkube_prometheus_stack_metrics_0_1_0"]=("undefined"!==typeof self?self:this)["webpackChunkkube_prometheus_stack_metrics_0_1_0"]||[]).push([[324],{1760:function(e,t,a){"use strict";a.r(t);var r=a(6758),n=a.n(r),l=a(935),s=a.n(l),o=s()(n());o.push([e.id,".expert-metrics[data-v-bc55bd56]{display:grid;gap:16px}.page-header[data-v-bc55bd56]{display:grid;gap:8px}.controls[data-v-bc55bd56]{display:flex;gap:12px;align-items:center;flex-wrap:wrap}.grid[data-v-bc55bd56]{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:16px}article[data-v-bc55bd56]{border:1px solid #ddd;border-radius:6px;padding:12px;background:#fff}.series[data-v-bc55bd56]{display:flex;gap:8px;flex-wrap:wrap}.summary[data-v-bc55bd56]{display:flex;gap:16px;margin-top:6px;color:#555;font-size:12px}.empty[data-v-bc55bd56]{color:#888}.debug[data-v-bc55bd56]{color:#999;font-size:12px}.error[data-v-bc55bd56]{color:#b00}",""]),t["default"]=o},2909:function(e,t,a){var r=a(1760);r.__esModule&&(r=r.default),"string"===typeof r&&(r=[[e.id,r,""]]),r.locals&&(e.exports=r.locals);var n=a(4825).A;n("5c59bdea",r,!0,{sourceMap:!1,shadowMode:!1})},3324:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return h}});var r=a(9274),n=a(4364);const l={class:"page expert-metrics"},s={class:"page-header"},o={class:"controls"},u={class:"debug"},c={class:"grid"},i={key:0,class:"error"};var d={__name:"kube-prometheus-stack-graphs",props:{resource:{type:Object,required:!1}},setup(e,{expose:t}){const a=e;function d(){}t({tabChange:d});const p={name:"ChartSeries",props:{series:{type:Array,required:!0},color:{type:String,default:"#2b8"},unit:{type:String,default:""}},setup(e){const t=460,a=160,n={top:10,right:20,bottom:22,left:42},l=t-n.left-n.right,s=a-n.top-n.bottom,o=(0,r.ref)(null),u=(0,r.ref)(0),c=(0,r.computed)(()=>{const t=(e.series||[]).flatMap(e=>e.points||[]),a=Math.min(...t.map(e=>e.t),Date.now()-36e5),r=Math.max(...t.map(e=>e.t),Date.now()),n=Math.max(...t.map(e=>e.v),1);return{minX:a,maxX:r,minY:0,maxY:n}});function i(e){const{minX:t,maxX:a}=c.value,r=Math.max(1,a-t);return n.left+(e-t)/r*l}function d(e){const{minY:t,maxY:a}=c.value,r=Math.max(1e-9,a-t);return n.top+s-(e-t)/r*s}function p(e){if(!e||!e.length)return"";let t=`M ${i(e[0].t)} ${d(e[0].v)}`;for(let a=1;a<e.length;a++)t+=` L ${i(e[a].t)} ${d(e[a].v)}`;return t}function m(e){return Array.from({length:e},(e,t)=>t)}const h=(0,r.computed)(()=>{const{minY:e,maxY:t}=c.value,a=4;return m(a+1).map(r=>e+r/a*(t-e))}),v=(0,r.computed)(()=>{const{minX:e,maxX:t}=c.value,a=4;return m(a+1).map(r=>Math.round(e+r/a*(t-e)))});function f(t){if(e.unit.includes("bytes")){const e=["B","KiB","MiB","GiB","TiB"];let a=0,r=t;while(r>=1024&&a<e.length-1)r/=1024,a++;return`${Math.round(100*r)/100} ${e[a]}`}return`${Math.round(100*t)/100} ${e.unit}`.trim()}function y(e){const t=new Date(e);return t.toLocaleTimeString()}function b(e){const t=e.currentTarget,a=t.getBoundingClientRect(),r=e.clientX-a.left-n.left;o.value=Math.max(0,Math.min(l,r));const{minX:s,maxX:i}=c.value,d=Math.max(1,i-s);u.value=Math.round(s+o.value/l*d)}function g(){o.value=null}function x(e,t){if(!t||!t.length)return null;let a=t[0],r=Math.abs(e-a.t);for(let n=1;n<t.length;n++){const l=Math.abs(e-t[n].t);l<r&&(r=l,a=t[n])}return a}const N=["#2b8","#28b","#b82","#b28","#282","#822"];return()=>{if(!e.series||!e.series.length)return(0,r.h)("div",{class:"empty"},"No data");const c=[...h.value.map((e,t)=>(0,r.h)("g",{key:"y"+t},[(0,r.h)("line",{x1:n.left,y1:d(e),x2:n.left+l,y2:d(e),stroke:"#eee"}),(0,r.h)("text",{x:n.left-6,y:d(e)+4,"text-anchor":"end",fill:"#666",style:"font-size:10px"},f(e))])),...v.value.map((e,t)=>(0,r.h)("g",{key:"x"+t},[(0,r.h)("line",{x1:i(e),y1:n.top+s,x2:i(e),y2:n.top+s+4,stroke:"#ccc"}),(0,r.h)("text",{x:i(e),y:n.top+s+16,"text-anchor":"middle",fill:"#666",style:"font-size:10px"},y(e))])),(0,r.h)("line",{x1:n.left,y1:n.top,x2:n.left,y2:n.top+s,stroke:"#ccc"}),(0,r.h)("line",{x1:n.left,y1:n.top+s,x2:n.left+l,y2:n.top+s,stroke:"#ccc"})],m=(e.series||[]).map((e,t)=>(0,r.h)("path",{key:"p"+t,d:p(e.points||[]),fill:"none",stroke:N[t%N.length],"stroke-width":2})),V=null!=o.value?[(0,r.h)("line",{x1:n.left+o.value,y1:n.top,x2:n.left+o.value,y2:n.top+s,stroke:"#888","stroke-dasharray":"3,3"}),...(e.series||[]).map((e,t)=>{const a=x(u.value,e.points||[]);return a?(0,r.h)("circle",{cx:i(a.t),cy:d(a.v),r:3,fill:N[t%N.length],stroke:"#fff"}):null}).filter(Boolean)]:[],k=null!=o.value?(0,r.h)("div",{class:"hover-readout"},[(0,r.h)("strong",null,y(u.value)+" "),...(e.series||[]).map((e,t)=>{const a=x(u.value,e.points||[]);return(0,r.h)("span",{style:`margin-left:8px;color:${N[t%N.length]}`},`${e.name||"series"}: ${a?f(a.v):"–"}`)})]):null;return(0,r.h)("div",{class:"series"},[(0,r.h)("svg",{width:t,height:a,style:"cursor:crosshair",onMousemove:b,onMouseleave:g},[...c,...m,...V]),k])}}},m={name:"SummaryRow",props:{series:{type:Array,required:!0},unit:{type:String,default:""}},setup(e){const t=(0,r.computed)(()=>{const t=(e.series||[]).flatMap(e=>e.points||[]).map(e=>e.v);return t.length?t[t.length-1]:0}),a=(0,r.computed)(()=>{const t=(e.series||[]).flatMap(e=>e.points||[]).map(e=>e.v);return t.length?Math.min(...t):0}),n=(0,r.computed)(()=>{const t=(e.series||[]).flatMap(e=>e.points||[]).map(e=>e.v);return t.length?Math.max(...t):0});return()=>(0,r.h)("div",{class:"summary"},[(0,r.h)("span",null,`Last: ${Math.round(100*t.value)/100} ${e.unit}`),(0,r.h)("span",null,`Min: ${Math.round(100*a.value)/100} ${e.unit}`),(0,r.h)("span",null,`Max: ${Math.round(100*n.value)/100} ${e.unit}`)])}},h=(0,r.ref)("1h"),v=(0,r.ref)(30);let f=null;const y=(0,r.computed)(()=>a.resource?.kind||a.resource?.type||"Deployment"),b=(0,r.computed)(()=>a.resource?.metadata?.name||a.resource?.name||"sample"),g=(0,r.computed)(()=>a.resource?.metadata?.namespace||a.resource?.namespace||"default"),x=(0,r.ref)([]),N=(0,r.ref)([]),V=(0,r.ref)([]),k=(0,r.ref)([]),_=(0,r.ref)([]),M=(0,r.ref)([]),w=(0,r.ref)("");function E(e){const t=Date.now(),a={"15m":9e5,"1h":36e5,"6h":216e5,"24h":864e5},r=a[e]||a["1h"],n=Math.max(1,Math.floor(r/598e3));return{from:t-r,to:t,stepSec:n}}async function $(e,t){const a=window.location.pathname.match(/\/(?:c|k8s\/clusters)\/([^/]+)/),r=a?.[1]||"local",l=`/k8s/clusters/${r}/api/v1/namespaces/prometheus/services/http:kube-prometheus-stack-prometheus:9090/proxy`,s=new URL(window.location.origin+l+"/api/v1/query_range");s.searchParams.set("query",e),s.searchParams.set("start",String(t.from/1e3)),s.searchParams.set("end",String(t.to/1e3)),s.searchParams.set("step",String(t.stepSec));const o=s.toString();n.log("[ExpertMetrics] Prometheus request:",o,"(cluster:",r,")");const u=await fetch(o);if(!u.ok)throw new Error(`Prometheus ${u.status}: ${await u.text()}`);const c=await u.json(),i=c?.data?.result??[];return i.map(e=>({name:Object.values(e.metric||{}).join(" "),points:(e.values||[]).map(([e,t])=>({t:1e3*e,v:parseFloat(t)}))}))}function S(e,t,a){return"pod"===(e||"").toLowerCase()?`pod="${a}"`:`namespace="${t}",pod=~"${a}.*"`}async function D(){try{w.value="";const e=E(h.value),t=S(y.value,g.value,b.value),a=`sum by (pod) (rate(container_cpu_usage_seconds_total{${t}}[5m]))`,r=`sum by (pod) (container_memory_working_set_bytes{${t}})`,n=`sum by (pod) (rate(container_network_receive_bytes_total{${t}}[5m]))`,l=`sum by (pod) (rate(container_network_transmit_bytes_total{${t}}[5m]))`,s=`sum by (pod) (rate(container_fs_reads_bytes_total{${t}}[5m]))`,o=`sum by (pod) (rate(container_fs_writes_bytes_total{${t}}[5m]))`,[u,c,i,d,p,m]=await Promise.all([$(a,e),$(r,e),$(n,e),$(l,e),$(s,e),$(o,e)]);x.value=u,N.value=c,V.value=i,k.value=d,_.value=p,M.value=m}catch(e){n.error("[ExpertMetrics] refresh error",e),w.value=e?.message||String(e)}}return(0,r.watch)(h,D),(0,r.watch)(v,()=>{f&&clearInterval(f),v.value>0&&(f=setInterval(D,1e3*v.value))}),(0,r.onMounted)(()=>{n.log("[ExpertMetrics] mounted",{kind:y.value,namespace:g.value,name:b.value}),D()}),(0,r.onUnmounted)(()=>{f&&clearInterval(f)}),(e,t)=>((0,r.openBlock)(),(0,r.createElementBlock)("div",l,[(0,r.createElementVNode)("header",s,[t[6]||(t[6]=(0,r.createElementVNode)("h1",null,"Expert Metrics",-1)),(0,r.createElementVNode)("div",o,[(0,r.createElementVNode)("label",null,[t[3]||(t[3]=(0,r.createTextVNode)(" Timeframe ",-1)),(0,r.withDirectives)((0,r.createElementVNode)("select",{"onUpdate:modelValue":t[0]||(t[0]=e=>h.value=e)},t[2]||(t[2]=[(0,r.createElementVNode)("option",{value:"15m"},"15m",-1),(0,r.createElementVNode)("option",{value:"1h"},"1h",-1),(0,r.createElementVNode)("option",{value:"6h"},"6h",-1),(0,r.createElementVNode)("option",{value:"24h"},"24h",-1)]),512),[[r.vModelSelect,h.value]])]),(0,r.createElementVNode)("label",null,[t[5]||(t[5]=(0,r.createTextVNode)(" Refresh ",-1)),(0,r.withDirectives)((0,r.createElementVNode)("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>v.value=e)},t[4]||(t[4]=[(0,r.createElementVNode)("option",{value:0},"Off",-1),(0,r.createElementVNode)("option",{value:15},"15s",-1),(0,r.createElementVNode)("option",{value:30},"30s",-1),(0,r.createElementVNode)("option",{value:60},"60s",-1)]),512),[[r.vModelSelect,v.value,void 0,{number:!0}]])]),(0,r.createElementVNode)("button",{onClick:D},"Refresh")]),(0,r.createElementVNode)("div",u,"Resource: "+(0,r.toDisplayString)(b.value)+" ("+(0,r.toDisplayString)(y.value)+") — Namespace: "+(0,r.toDisplayString)(g.value),1)]),(0,r.createElementVNode)("section",c,[(0,r.createElementVNode)("article",null,[t[7]||(t[7]=(0,r.createElementVNode)("h3",null,"CPU (cores)",-1)),(0,r.createVNode)(p,{series:x.value,color:"#2b8",unit:"cores"},null,8,["series"]),(0,r.createVNode)(m,{series:x.value,unit:"cores"},null,8,["series"])]),(0,r.createElementVNode)("article",null,[t[8]||(t[8]=(0,r.createElementVNode)("h3",null,"Memory (bytes)",-1)),(0,r.createVNode)(p,{series:N.value,color:"#28b",unit:"bytes"},null,8,["series"]),(0,r.createVNode)(m,{series:N.value,unit:"bytes"},null,8,["series"])]),(0,r.createElementVNode)("article",null,[t[9]||(t[9]=(0,r.createElementVNode)("h3",null,"Network RX (bytes/s)",-1)),(0,r.createVNode)(p,{series:V.value,color:"#b82",unit:"bytes/s"},null,8,["series"]),(0,r.createVNode)(m,{series:V.value,unit:"bytes/s"},null,8,["series"])]),(0,r.createElementVNode)("article",null,[t[10]||(t[10]=(0,r.createElementVNode)("h3",null,"Network TX (bytes/s)",-1)),(0,r.createVNode)(p,{series:k.value,color:"#b28",unit:"bytes/s"},null,8,["series"]),(0,r.createVNode)(m,{series:k.value,unit:"bytes/s"},null,8,["series"])]),(0,r.createElementVNode)("article",null,[t[11]||(t[11]=(0,r.createElementVNode)("h3",null,"Disk Read (bytes/s)",-1)),(0,r.createVNode)(p,{series:_.value,color:"#282",unit:"bytes/s"},null,8,["series"]),(0,r.createVNode)(m,{series:_.value,unit:"bytes/s"},null,8,["series"])]),(0,r.createElementVNode)("article",null,[t[12]||(t[12]=(0,r.createElementVNode)("h3",null,"Disk Write (bytes/s)",-1)),(0,r.createVNode)(p,{series:M.value,color:"#822",unit:"bytes/s"},null,8,["series"]),(0,r.createVNode)(m,{series:M.value,unit:"bytes/s"},null,8,["series"])])]),w.value?((0,r.openBlock)(),(0,r.createElementBlock)("div",i,(0,r.toDisplayString)(w.value),1)):(0,r.createCommentVNode)("",!0)]))}},p=(a(2909),a(7433));const m=(0,p.A)(d,[["__scopeId","data-v-bc55bd56"]]);var h=m}}]);
//# sourceMappingURL=kube-prometheus-stack-metrics-0.1.0.umd.min.324.js.map